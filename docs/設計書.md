# RESERVE-API 設計書（MVP）

## 1. 目的と範囲

- 目的：職員向け予約の CRUD API を提供
- 範囲：/reservations の作成・取得・更新・削除（検索は最小）
- DB：SQLite（単一ノード） + TypeORM

## 2. 非機能と前提

- TZ：保存=UTC、表示=JST
- ID：数値の自動採番
- 同時実行：低頻度前提
- ログ：method, path, status, latency, requestId
- ドキュメント：Swagger `/api`

## 3. データモデル（MVP）

- Reservation:
  - 必須
    id:number 予約ナンバー
    staffId:number　　
    patientId:number
    startAt:datetime(UTC)
    endAt:datetime(UTC)

  - 任意: note?:string

- 整合: startAt < endAt

## 4. API 契約

### 4.1 POST /reservations

- Req: { staffId:number, startAt:ISO8601(UTC), endAt:ISO8601(UTC), note?:string }
- Res: 201 + Reservation
- Errors: 400(検証), 409(将来:重複)

### 4.2 GET /reservations

- Query(将来): staffId, from, to
- Res: 200 + Reservation[]
- Errors: 200/空配列

### 4.3 GET /reservations/:id

- Res: 200 + Reservation
- Errors: 404

### 4.4 PATCH /reservations/:id

- Req: 任意項目の部分更新
- Res: 200 + Reservation
- Errors: 400, 404, 409(将来)

### 4.5 DELETE /reservations/:id

- Res: 204
- Errors: 404

## 5. バリデーション仕様（DTO）

- staffId: 整数, >0
- startAt: ISO8601(UTC)
- endAt: ISO8601(UTC), endAt > startAt
- note: 最大500文字
- 形式: 400 { errors: [{field, reason}] }

## 6. エラー設計

- 400 BadRequest: 入力不正
- 404 NotFound: IDなし
- 409 Conflict: 将来の重複検知用
- 500 Internal: 想定外
- 返却形式: { code:string, message:string, details?:any }

## 7. 設定/運用

- .env: PORT, SQLITE_PATH
- .env.example 提供
- マイグレーション: MVPは synchronize=true、スキーマ確定後に false + migration 方針
- バックアップ: 停止→DBファイルコピー

## 8. テスト計画（最小）

- E2E: POST→GET（永続化）, 404, 400
- Unit(Service): Happy/NotFound
- 再現手順: クリーン環境で10分以内にCRUD確認

## 9. 将来拡張（未実装の設計指針）

- 予約重複検知（同一staffId×時刻帯）
- 検索条件の拡張（pagination / sort / filter）
- 認証/認可（ロール）, 監査ログ
- DB差替え（PostgreSQL）と移行手順
